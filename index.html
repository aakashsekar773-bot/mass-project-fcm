<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Number Login & Notification Setup</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status-message { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; }
        .red { color: white; background-color: #f44336; }
        .blue { color: white; background-color: #2196F3; }
        .green { color: white; background-color: #4CAF50; }
        .error { color: red; }
    </style>
</head>
<body>

    <h1>ðŸ“± Phone Number Login</h1>
    <p>Please enter your phone number to enable notifications.</p>

    <form id="loginForm">
        <label for="phone">Phone Number: </label>
        <input type="text" id="phone" name="phone" value="9361033781" required>
        <button type="submit" id="loginBtn">Submit & Enable Notifications</button>
    </form>

    <div id="statusMessage" class="status-message blue">Awaiting action...</div>
    <div id="errorDisplay" class="error"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

    <script>
        // CLIENT SIDE CONFIGURATION - (à®‰à®™à¯à®•à®³à¯ à®šà®°à®¿à®¯à®¾à®© à®®à®¤à®¿à®ªà¯à®ªà¯à®•à®³à¯ˆà®•à¯ à®•à¯Šà®£à¯à®Ÿà¯ à®¨à®¿à®°à®ªà¯à®ªà®ªà¯à®ªà®Ÿà¯à®Ÿà¯à®³à¯à®³à®¤à¯)
        const firebaseConfig = {
            apiKey: "AIzaSyDdI8IAXnTuml1RG7CPmTjEuuTjktn-KSA",
            authDomain: "project-mass-fbd52.firebaseapp.com",
            projectId: "project-mass-fbd52",
            storageBucket: "project-mass-fbd52.firebasestorage.app",
            messagingSenderId: "768930454542",
            appId: "1:768930454542:web:3fe15d047a48bab349f05f"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            var messaging = firebase.messaging();
            document.getElementById('statusMessage').textContent = 'Firebase initialized.';
        } catch (e) {
            console.error('Firebase Initialization Error:', e);
            document.getElementById('errorDisplay').textContent = 'Critical Error: Firebase Initialization Failed.';
            document.getElementById('statusMessage').style.backgroundColor = 'red';
            document.getElementById('statusMessage').textContent = 'Initialization Failed';
            throw e; 
        }

        const loginForm = document.getElementById('loginForm');
        const statusEl = document.getElementById('statusMessage');
        const errorEl = document.getElementById('errorDisplay');
        // VAPID Public Key - à®‡à®¤à¯ˆ à®¨à¯€à®™à¯à®•à®³à¯ à®•à¯Šà®Ÿà¯à®¤à¯à®¤à®¿à®°à¯à®¨à¯à®¤à¯€à®°à¯à®•à®³à¯, à®‡à®¤à¯ à®šà®°à®¿à®¯à®¾à®• à®‡à®°à¯à®•à¯à®• à®µà¯‡à®£à¯à®Ÿà¯à®®à¯.
        const vapidKey = "BN_Bi5TO9ChOFdoT3WnJt6c79316Jg8h295Jtq-9Y4Xp8tM9F-d11iQ_c_YgU5W525WxY05GUp"; 

        // Function to register Service Worker and get token
        function requestPermissionAndGetToken(phone) {
            statusEl.textContent = 'Requesting Notification Permission...';
            statusEl.style.backgroundColor = 'blue';

            // 1. Service Worker Registration
            // Service Worker à®ƒà®ªà¯ˆà®²à¯ (firebase-messaging-sw.js) à®°à¯‚à®Ÿà¯-à®²à¯ à®‰à®³à¯à®³à®¤à®¾à®²à¯, à®ªà®¾à®¤à¯ˆ à®šà®°à®¿.
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/firebase-messaging-sw.js') 
                .then((registration) => {
                    console.log('Service Worker registered with scope:', registration.scope);
                    // 2. Request Notification Permission
                    return Notification.requestPermission(); 
                })
                .then((permission) => {
                    if (permission === 'granted') {
                        statusEl.textContent = 'Permission granted. Getting Token...';
                        // 3. Get FCM Token
                        return messaging.getToken({ vapidKey: vapidKey });
                    } else {
                        throw new Error('Notification permission denied or blocked.');
                    }
                })
                .then((token) => {
                    if (token) {
                        statusEl.textContent = 'Token received. Sending to server...';
                        console.log('FCM Token:', token);

                        // 4. Send Token to Server (Your Vercel API)
                        return fetch('/api/login.js', { // <--- Vercel API Path
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phone: phone, token: token })
                        });
                    } else {
                        throw new Error('Failed to get FCM token. Notifications blocked?');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusEl.textContent = 'Success! Phone number registered.';
                        statusEl.style.backgroundColor = 'green';
                        errorEl.textContent = '';
                    } else {
                        statusEl.textContent = 'Server Error: ' + data.message;
                        statusEl.style.backgroundColor = 'red';
                        errorEl.textContent = '';
                    }
                })
                .catch((error) => {
                    console.error('Login Process Error:', error);
                    errorEl.textContent = 'Critical Error: ' + error.message;
                    statusEl.textContent = 'Process Failed';
                    statusEl.style.backgroundColor = 'red';
                });
            } else {
                errorEl.textContent = 'Critical Error: Service Workers are not supported by this browser.';
                statusEl.textContent = 'Browser Not Supported';
                statusEl.style.backgroundColor = 'red';
            }
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const phoneInput = document.getElementById('phone').value;
            requestPermissionAndGetToken(phoneInput);
        });
        
    </script>
</body>
</html>
    
